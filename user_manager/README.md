# Family Hub - User Manager Application

**Family Hub** プロジェクト内の **User Manager Application** は、Spring Boot 3 と Spring Security を利用したユーザ管理・認証システムです。  
このアプリケーションは、ユーザ登録、ログイン（JWT発行）、および認証済みユーザ情報の取得などの基本機能を提供します。  
また、今後の拡張として、パスワード変更やユーザ削除、リフレッシュトークンによる再認証などの機能を追加することが可能です。

---

## 1. システムの概要

### 主な機能
- **ユーザ管理**  
  - ユーザ登録（新規ユーザの情報をデータベースに保存）  
  - パスワードのハッシュ化（BCryptを利用）  
- **認証機能**  
  - ログイン時にユーザ名・パスワードの検証を行い、認証成功時に JWT（アクセストークン）を発行  
- **認証済みユーザ情報取得**  
  - アクセストークンに含まれる情報をもとに、認証済みユーザの情報を返す

### 使用技術
- **バックエンド:** Spring Boot 3, Spring Security, JPA  
- **認証:** 自作の認証モジュール（JWT発行・検証にJJWTを利用）  
- **データベース:** H2（開発環境の場合）、MySQL/PostgreSQL などへの切替が可能

---

## 2. 機能

### 2.1 ユーザ登録

**概要:**  
ユーザは登録フォームに必要な情報（ユーザ名、パスワード、メール）を入力し、送信します。  
システムは、同じユーザ名が既に存在しないかをチェックし、存在しなければパスワードをハッシュ化して新規ユーザとしてデータベースに保存します。

![ユーザ登録 シーケンス図](./uml/register.png)

**ポイント:**
- **入力:** ユーザがフロントエンドの登録フォームに情報を入力。
- **検証:** AuthController がリクエストを受け、AuthService で既存ユーザのチェックを実施。
- **処理:** 新規ユーザの場合、パスワードをハッシュ化してデータベースに保存。
- **結果:** 登録成功なら「User registered: username」、重複の場合はエラーが返される。

---

### 2.2 ログイン（認証）

**概要:**  
ユーザはログインフォームにユーザ名とパスワードを入力します。  
システムは入力された情報をもとにユーザを検索し、パスワードの検証を行います。  
認証成功時には、JWTトークンが発行され、フロントエンドに返されます。

![ログイン シーケンス図](./uml/login.png)

**ポイント:**
- **入力:** ユーザがログインフォームにユーザ名とパスワードを入力。
- **認証:** AuthService がユーザ情報を取得し、BCryptを使ってパスワードを検証。
- **トークン発行:** パスワードが正しければ、TokenService によりJWTトークンが生成される。
- **結果:** 正常な場合、JWTトークンが返され、不正な場合は401エラーが返される。

---

### 2.3 保護されたAPIへのアクセス（認証済みユーザ情報取得）

**概要:**  
ユーザはログイン後に発行されたJWTトークンを利用して、保護されたAPI（例：`/auth/userinfo`）にアクセスします。  
リクエスト時にJWTトークンが付与され、システム側（JwtAuthenticationFilter）がトークンを検証し、認証済みユーザ情報を取得して返します。

![認証 シーケンス図](./uml/auth.png)

**ポイント:**
- **リクエスト:** フロントエンドは、JWTトークンを含むGETリクエストを保護されたAPIへ送信。
- **トークン検証:** JwtAuthenticationFilter がTokenServiceを使ってJWTトークンの検証を実施。
- **認証:** トークンが有効であれば、ユーザ名が抽出され、UserRepositoryからユーザ情報を取得。
- **結果:** 認証済みユーザ情報がUserInfoControllerから返され、無効な場合は401 Unauthorizedエラーが返される。

---

## 3. ビルド・実行方法

1. **プロジェクトディレクトリに移動**

   ```sh
   cd user_manager
   ```

2. **アプリケーションの起動**

   Maven Wrapper が同梱されている場合：
   ```sh
   ./mvnw spring-boot:run
   ```
   Maven Wrapper がない場合：
   ```sh
   mvn spring-boot:run
   ```

3. **起動確認:**  
   コンソールにログが表示され、[http://localhost:8080](http://localhost:8080) でアプリケーションが稼働していることを確認してください。

---

## 4. テストの実行

プロジェクトルートディレクトリで以下のコマンドを実行します。

```sh
mvn clean test
```

すべてのテストクラスが自動検出され、実行されます。  
特定のテストクラスのみ実行する場合は、例えば次のように指定します。

```sh
mvn -Dtest=AuthControllerIntegrationTest test
```

---

## 5. API 使用例

### 5.1 ユーザ登録

```sh
curl -X POST http://localhost:8080/auth/register \
     -H "Content-Type: application/json" \
     -d '{"username": "johndoe", "password": "password", "email": "john@example.com"}'
```

**期待されるレスポンス:**

```
User registered: johndoe
```

### 5.2 ログイン

```sh
curl -X POST http://localhost:8080/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username": "johndoe", "password": "password"}'
```

**期待されるレスポンス (JSON):**

```json
{
  "accessToken": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJqb2huZG9lIiwicm9sZXMiOiJST0xFX1VTRVIiLCJpYXQiOjE2MjY3NjY5MDAsImV4cCI6MTYyNjc3MDUwMH0.XXXXXXXXXXXXX"
}
```

### 5.3 認証済みユーザ情報取得

```sh
curl -X GET http://localhost:8080/auth/userinfo \
     -H "Authorization: Bearer <取得したアクセストークン>"
```

**期待されるレスポンス (JSON):**

```json
{
  "username": "johndoe",
  "authorities": [
    {
      "authority": "ROLE_USER"
    }
  ]
}
```

---

## 6. 欠点と改善の余地

- **CORS 対応:**  
  フロントエンドと連携する場合、Spring Boot 側でCORS設定を追加してください。

- **HTTPS の利用:**  
  通信の暗号化のためHTTPSを利用する方がより望ましいです。

- **データベースの永続化への移行:**  
  現在は開発用としてH2インメモリデータベースを利用していますが、実際の使用を想定した場合はMySQL、PostgreSQL、Oracleなどの永続的なデータ保存が可能なデータベースへの切り替えが必要となります。  

- **UI/UXの改善:**  
  user_managerのWebフロントエンドを作成し、ユーザ作成時等の操作性向上を図ることで、より直感的かつ快適に使用できるようにすることが望ましいです。

- **エラーハンドリング:**  
  ユーザ向けに分かりやすいエラーメッセージやエラーページを実装し、問題発生時にユーザが状況を把握しやすくすることが重要です。  

- **ログとモニタリング:**  
  運用中の障害対応を迅速に行うため、システムログの整備やPrometheus、Grafana、ELK Stackなどのモニタリングツールの導入を検討してください。  

- **機能の限定性:**  
  現在はユーザ登録、ログイン、JWT発行、認証済みユーザ情報の取得など基本機能のみ実装されています。  
  今後、パスワード変更、ユーザ削除、リフレッシュトークン、さらには多要素認証 (MFA) やシングルサインオン (SSO) の実装など、より高度な機能を追加することで、よりセキュリティ要件の高いシナリオにも対応可能となります。

- **Adminユーザの導入**  
  ユーザ削除等の機能追加を行った場合、それを誰でも実行できる状態は望ましくありません。  
  user_managerの利用者と管理者を区別する為の認証機能を追加するのが望ましいです。

- **セキュリティのリスク:**  
  現実装では、トークンの無効化処理、入力検証、エラーハンドリング、ログ出力の充実など、セキュリティ面の強化が求められます。
  それでも個人で自作できるレベルのプログラムの場合、実装ミスやセキュリティ対策の不足が生じやすく、一般的な製品よりも脆弱性のリスクがあります。  

- **メンテナンスと拡張性:**  
  認証・認可機能はシステムの中核部分であり、標準プロトコル（OAuth2、OIDC、SAML等）に完全には準拠していない場合、他システムとの統合や将来的な仕様変更への対応が困難になる可能性があります。  
  標準プロトコルへの準拠や柔軟な拡張ポイントの設計など、運用・保守の負担軽減が今後の改善点です。  
  今後Keycloakなどの標準的な認証サーバへ移行する場合は、フロントエンドおよびバックエンドの認証フローを変更する必要があります。

- **スケーラビリティ:**  
  現行実装はシンプルな構成のため、ユーザ数やアクセス数の増加時にパフォーマンスやスケーラビリティで課題が生じる可能性があります。  
  キャッシュ戦略の導入や分散環境への対応など、スケールアップを見据えた改善が必要です.
